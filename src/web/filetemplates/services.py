import logging
import os
import re
import unicodedata

import aiofiles as aiof
from docx import Document
from fastapi import Request, UploadFile
from settings import (
    BASE_URL,
    STATIC_FOLDER,
    TEMPLATES_DIR,
    TEMPLATES_FOLDER,
)
from web.filetemplates.schemas import DocumentField, RequestModel

logger = logging.getLogger('control')


async def save_file(new_file: UploadFile) -> str:
    filename = new_file.filename
    path_to_file = os.path.join(TEMPLATES_DIR, filename)
    async with aiof.open(path_to_file, 'wb+') as f:
        await f.write(new_file.file.read())
    return filename


def get_full_link(request: Request, filename: str) -> str:
    base_url = BASE_URL or str(request.base_url)
    return f'{base_url}api/{STATIC_FOLDER}/{TEMPLATES_FOLDER}/{filename}'


def delete_file(filename: str) -> None:
    logger.debug(f'Delete file {filename}')
    try:
        os.remove(os.path.join(TEMPLATES_DIR, filename))
    except FileNotFoundError:
        pass


def replace_text_in_runs(runs, replacements):
    full_text = ''.join(run.text for run in runs).strip()
    full_text = unicodedata.normalize(
        'NFKD', full_text
    )
    full_text = re.sub(
        r'\s+', ' ', full_text
    )
    full_text = full_text.replace('“', '{').replace(
        '”', '}'
    )

    if not full_text:
        return

    modified = False
    for key, value in replacements.items():
        search_key = f'{{{{{key}}}}}'
        if search_key in full_text:
            full_text = full_text.replace(search_key, value)
            modified = True

    if modified:
        runs[0].text = full_text
        for run in runs[1:]:
            run.text = ''


def insert_list_into_table(table, list_data):
    if not list_data:
        return
    column_mapping = {}
    for row_idx, row in enumerate(table.rows):
        for col_idx, cell in enumerate(row.cells):
            cell_text = cell.text.strip()
            for key in list_data[0].keys():
                if f'{{{{{key}}}}}' in cell_text:
                    column_mapping[key] = (row_idx, col_idx)
                    cell.text = ''
        if column_mapping:
            break

    if not column_mapping:
        return

    base_row_idx = min(
        row_idx for row_idx, _ in column_mapping.values()
    )

    for item in list_data:
        if base_row_idx < len(table.rows):
            row = table.rows[base_row_idx]
        else:
            row = table.add_row()

        for key, (r_idx, col_idx) in column_mapping.items():
            if col_idx < len(row.cells):
                row.cells[col_idx].text = item.get(key, '')

        base_row_idx += 1


def run_generated_file(
    request_data: RequestModel,
    doc: DocumentField,
    template_path: str,
    output_path: str,
) -> None:
    word_doc = Document(template_path)
    all_fields = request_data.common_fields.copy()
    all_fields.update(
        {k: v for k, v in doc.fields.items() if not isinstance(v, list)}
    )

    for para in word_doc.paragraphs:
        replace_text_in_runs(para.runs, all_fields)

    for table in word_doc.tables:
        for row in table.rows:
            for cell in row.cells:
                for para in cell.paragraphs:
                    replace_text_in_runs(para.runs, all_fields)

    for key, value in doc.fields.items():
        if isinstance(value, list):
            for table in word_doc.tables:
                insert_list_into_table(table, value)
    word_doc.save(output_path)


def delete_files(generated_files: list) -> None:
    for file_path in generated_files:
        try:
            os.remove(file_path)
        except OSError:
            pass
